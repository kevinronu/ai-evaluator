---
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import Layout from "../layouts/Layout.astro";
---

<Layout>
  <h1 class="text-red-600 dark:text-green-500">AI Evaluator</h1>
  <form data-ref="evaluator__form">
    <label
      >Project Name:
      <input type="text" name="storeName" required />
    </label>

    <label
      >Upload Files:
      <input type="file" name="documents" multiple required />
    </label>

    <progress max="100" value="0" data-ref="evaluator__upload-progress"
    ></progress>

    <button type="submit">Evaluate</button>
  </form>
</Layout>
<script type="module">
  const form = document.querySelector(`[data-ref="evaluator__form"]`);

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const { storeName, documents } = e.target;

    const formData = new FormData();
    formData.append("storeName", storeName.value);

    for (const file of documents.files) {
      formData.append("files", file);
    }

    const progressBar = form.querySelector(
      `[data-ref="evaluator__upload-progress"]`
    );

    if (progressBar) {
      progressBar.value = 0;
    }

    const xhr = new XMLHttpRequest();
    xhr.open("POST", "/api/upload");

    xhr.upload.addEventListener("progress", (event) => {
      if (event.lengthComputable && progressBar) {
        progressBar.value = (event.loaded / event.total) * 100;
      }
    });

    xhr.onload = () => {
      const result = JSON.parse(xhr.responseText);

      const params = new URLSearchParams({
        projectName: result.vector_store_name,
        storeID: result.vector_store_id,
        language: `Spanish`,
      });

      window.location.href = `/evaluate?${params.toString()}`;
    };

    xhr.onerror = () => {
      alert("Upload failed.");
    };

    xhr.send(formData);
  });
</script>
